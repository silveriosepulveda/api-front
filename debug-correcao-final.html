<!DOCTYPE html>
<html lang="pt-br" ng-app="debugModalApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - PopUpModal Corre√ß√£o</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .debug-box { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #cce7ff; border-color: #b8daff; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        .log { background: #1a202c; color: #e2e8f0; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .modal.show { z-index: 1050 !important; }
        .modal-backdrop { z-index: 1040 !important; }
        .estado { font-weight: bold; padding: 5px 10px; border-radius: 3px; margin: 2px; display: inline-block; }
        .estado.true { background: #28a745; color: white; }
        .estado.false { background: #dc3545; color: white; }
        .estado.undefined { background: #6c757d; color: white; }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body ng-controller="DebugController">
    <div class="container">
        <h1>üîß Debug: PopUpModal rotaCarregada - CORRE√á√ÉO APLICADA</h1>
        
        <div class="debug-box success">
            <h3>‚úÖ Corre√ß√£o Implementada</h3>
            <p><strong>Prote√ß√£o contra m√∫ltiplas execu√ß√µes adicionada:</strong></p>
            <ul>
                <li>Vari√°vel de controle <code>carregamentoIniciado</code></li>
                <li>Verifica√ß√£o antes de cada chamada de <code>carregarRota()</code></li>
                <li>Reset do controle ap√≥s sucesso ou erro</li>
                <li>Logs detalhados para rastreamento</li>
            </ul>
        </div>

        <div class="debug-box info">
            <h3>üéÆ Controles de Teste</h3>
            <button ng-click="simularPopUpModal()">üöÄ Simular PopUpModal</button>
            <button ng-click="testarMultiplasExecucoes()">üîÑ Testar M√∫ltiplas Execu√ß√µes</button>
            <button ng-click="simularCarregamentoLento()">‚è±Ô∏è Simular Carregamento Lento</button>
            <button ng-click="limparLogs()" style="background: #ffc107; color: black;">üßπ Limpar</button>
        </div>

        <div class="debug-box" ng-if="modalState">
            <h3>üìä Estado do Modal Simulado</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <div>rotaCarregada: <span class="estado" ng-class="modalState.rotaCarregada">{{modalState.rotaCarregada}}</span></div>
                <div>carregamentoIniciado: <span class="estado" ng-class="modalState.carregamentoIniciado">{{modalState.carregamentoIniciado}}</span></div>
                <div>rota: <span style="background: #e9ecef; padding: 5px; border-radius: 3px;">{{modalState.rota}}</span></div>
                <div>classeEstrutura: <span style="background: #e9ecef; padding: 5px; border-radius: 3px;">{{modalState.classeEstrutura}}</span></div>
            </div>
            
            <div style="margin-top: 10px;">
                <strong>üîç ng-show conditions:</strong><br>
                <code>ng-show="rotaCarregada"</code> = <span class="estado" ng-class="modalState.rotaCarregada">{{modalState.rotaCarregada ? 'VIS√çVEL' : 'OCULTO'}}</span><br>
                <code>ng-show="!rotaCarregada"</code> = <span class="estado" ng-class="!modalState.rotaCarregada">{{!modalState.rotaCarregada ? 'VIS√çVEL' : 'OCULTO'}}</span>
            </div>
        </div>

        <div class="debug-box" ng-if="logs.length > 0">
            <h3>üìù Logs de Execu√ß√£o</h3>
            <div class="log">
<span ng-repeat="log in logs track by $index">[{{log.timestamp}}] {{log.nivel}} - {{log.mensagem}}
</span>
            </div>
        </div>

        <div class="debug-box warning">
            <h3>üîç Logs Esperados (CORRIGIDO)</h3>
            <div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px;">
üöÄ [PopUpModal] Controller inicializado
üîÑ [PopUpModal] carregarRota iniciado
‚ö†Ô∏è [PopUpModal] carregarRota j√° est√° em execu√ß√£o, ignorando  ‚Üê PROTE√á√ÉO
‚úÖ [PopUpModal] Modal j√° carregado ou em carregamento, n√£o inicializando novamente
‚è∞ [PopUpModal] Timeout executado - definindo rotaCarregada = true
‚úÖ [PopUpModal] Modal preparado com local-exibicao="modal"
            </div>
            <p><strong>‚úÖ Se aparecer "carregarRota j√° est√° em execu√ß√£o, ignorando" = CORRE√á√ÉO FUNCIONANDO!</strong></p>
        </div>

        <!-- Modal de teste -->
        <div class="modal fade" id="teste-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üß™ Teste PopUpModal Corrigido</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Simula√ß√£o do template PopUpModal -->
                        <div ng-show="!modalState.rotaCarregada" class="text-center" style="padding: 50px;">
                            <i class="fa fa-spinner fa-spin fa-2x"></i>
                            <p>Preparando modal...</p>
                        </div>
                        <div ng-show="modalState.rotaCarregada" style="border: 2px solid #28a745; background: #d4edda; padding: 20px; border-radius: 5px;">
                            <h4>‚úÖ estrutura-gerencia CARREGADA!</h4>
                            <p><strong>local-exibicao:</strong> modal</p>
                            <p><strong>classe:</strong> {{modalState.classeEstrutura}}</p>
                            <p><strong>rota:</strong> {{modalState.rota}}</p>
                            <p><em>Esta seria a estrutura-gerencia real funcionando no modal.</em></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    
    <script>
        var app = angular.module('debugModalApp', []);
        
        app.controller('DebugController', function($scope, $timeout) {
            $scope.logs = [];
            $scope.modalState = null;
            
            function addLog(nivel, mensagem) {
                $scope.logs.push({
                    timestamp: new Date().toLocaleTimeString(),
                    nivel: nivel,
                    mensagem: mensagem
                });
                console.log(`[${nivel}] ${mensagem}`);
            }
            
            function criarModalState() {
                return {
                    rotaCarregada: false,
                    carregamentoIniciado: false,
                    rota: '/sistema-empresas-grupos/empresasGrupos',
                    classeEstrutura: 'empresas',
                    subacao: 'cadastro'
                };
            }
            
            function simularCarregarRota(state) {
                // NOVA PROTE√á√ÉO IMPLEMENTADA
                if (state.carregamentoIniciado) {
                    addLog('WARNING', '‚ö†Ô∏è carregarRota j√° est√° em execu√ß√£o, ignorando');
                    return false; // Prote√ß√£o funcionando!
                }
                
                addLog('INFO', 'üîÑ carregarRota iniciado');
                state.carregamentoIniciado = true;
                
                $timeout(function() {
                    addLog('SUCCESS', '‚è∞ Timeout executado - definindo rotaCarregada = true');
                    state.rotaCarregada = true;
                    state.carregamentoIniciado = false; // Reset ap√≥s sucesso
                    addLog('SUCCESS', '‚úÖ Modal preparado com local-exibicao="modal"');
                }, 100);
                
                return true;
            }
            
            $scope.simularPopUpModal = function() {
                addLog('START', '=== SIMULA√á√ÉO POPUPMODAL CORRIGIDO ===');
                
                $scope.modalState = criarModalState();
                
                addLog('INFO', 'üöÄ Controller inicializado');
                addLog('DEBUG', '   - Rota: ' + $scope.modalState.rota);
                addLog('DEBUG', '   - Classe: ' + $scope.modalState.classeEstrutura);
                
                // Simular m√∫ltiplas tentativas de inicializa√ß√£o (problema original)
                simularCarregarRota($scope.modalState); // 1¬™ chamada
                
                $timeout(function() {
                    addLog('INFO', 'üîÑ ViewContentLoaded - verificando se precisa inicializar');
                    if (!$scope.modalState.rotaCarregada && !$scope.modalState.carregamentoIniciado) {
                        simularCarregarRota($scope.modalState); // 2¬™ chamada
                    } else {
                        addLog('SUCCESS', '‚úÖ Modal j√° carregado ou em carregamento, n√£o inicializando novamente');
                    }
                }, 10);
                
                $timeout(function() {
                    addLog('INFO', 'üîó Link function - verificando estado');
                    if (!$scope.modalState.rotaCarregada && !$scope.modalState.carregamentoIniciado) {
                        simularCarregarRota($scope.modalState); // 3¬™ chamada
                    } else {
                        addLog('SUCCESS', '‚úÖ Link - modal j√° carregado ou em carregamento');
                    }
                }, 20);
                
                $timeout(function() {
                    addLog('INFO', 'üëÅÔ∏è Modal mostrado - verificando carregamento');
                    if (!$scope.modalState.rotaCarregada && !$scope.modalState.carregamentoIniciado) {
                        simularCarregarRota($scope.modalState); // 4¬™ chamada
                    } else {
                        addLog('SUCCESS', '‚úÖ Modal mostrado - j√° carregado ou em carregamento');
                    }
                }, 30);
                
                // Mostrar modal de teste
                $timeout(function() {
                    var modal = new bootstrap.Modal(document.getElementById('teste-modal'));
                    modal.show();
                }, 500);
            };
            
            $scope.testarMultiplasExecucoes = function() {
                addLog('START', '=== TESTE M√öLTIPLAS EXECU√á√ïES ===');
                
                $scope.modalState = criarModalState();
                
                // Simular 10 chamadas r√°pidas (cen√°rio problem√°tico)
                for (var i = 1; i <= 10; i++) {
                    $timeout(function(i) {
                        return function() {
                            addLog('DEBUG', `üîÑ Tentativa ${i} de carregarRota()`);
                            simularCarregarRota($scope.modalState);
                        };
                    }(i), i * 5);
                }
                
                addLog('INFO', 'Executando 10 tentativas r√°pidas...');
                addLog('WARNING', 'Esperado: apenas 1 sucesso + 9 "j√° est√° em execu√ß√£o, ignorando"');
            };
            
            $scope.simularCarregamentoLento = function() {
                addLog('START', '=== TESTE CARREGAMENTO LENTO ===');
                
                $scope.modalState = criarModalState();
                
                addLog('INFO', 'üêå Simulando carregamento lento (500ms)...');
                
                if (simularCarregarRota($scope.modalState)) {
                    // Modificar o timeout para ser mais lento
                    $timeout(function() {
                        addLog('SUCCESS', '‚è∞ Timeout lento executado - definindo rotaCarregada = true');
                        $scope.modalState.rotaCarregada = true;
                        $scope.modalState.carregamentoIniciado = false;
                        addLog('SUCCESS', '‚úÖ Modal lento preparado');
                    }, 500);
                }
                
                // Tentar carregar novamente durante o carregamento
                $timeout(function() {
                    addLog('DEBUG', 'üîÑ Tentativa durante carregamento...');
                    simularCarregarRota($scope.modalState);
                }, 250);
            };
            
            $scope.limparLogs = function() {
                $scope.logs = [];
                $scope.modalState = null;
                console.clear();
                addLog('INFO', 'Logs limpos');
            };
        });
    </script>
</body>
</html>
